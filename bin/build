#!/bin/sh
set -e
cd "`dirname "$0"`/.."

DIST_FOLDER=${DIST_FOLDER:-$PWD/dist}
SRC_FOLDER=${SRC_FOLDER:-$PWD/src}

cmd() {
    docker run \
        -i \
        -t=$([ -t 0 ] && echo "true" || echo "false") \
        -v $DIST_FOLDER:$DIST_FOLDER \
        -v $SRC_FOLDER:$SRC_FOLDER \
        --entrypoint=/bin/sh \
        --rm \
        golang:1.6 -c "$@"
}

cmd "rm $DIST_FOLDER/syslog-stdout*" > /dev/null || :

cmd "CGO_ENABLED=0 GOOS=linux GOARTCH=386 go build -o $DIST_FOLDER/syslog-stdout-linux-386 $SRC_FOLDER/syslog-stdout.go"
cmd "CGO_ENABLED=0 GOOS=linux GOARTCH=amd64 go build -o $DIST_FOLDER/syslog-stdout-linux-amd64 $SRC_FOLDER/syslog-stdout.go"
cmd "CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=5 go build -o $DIST_FOLDER/syslog-stdout-linux-armv5 $SRC_FOLDER/syslog-stdout.go"
cmd "CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=6 go build -o $DIST_FOLDER/syslog-stdout-linux-armv6 $SRC_FOLDER/syslog-stdout.go"
cmd "CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=7 go build -o $DIST_FOLDER/syslog-stdout-linux-armv7 $SRC_FOLDER/syslog-stdout.go"
cmd "CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o $DIST_FOLDER/syslog-stdout-linux-armv8 $SRC_FOLDER/syslog-stdout.go"

cmd "cd $DIST_FOLDER && tar czpf syslog-stdout.tar.gz syslog-stdout-*"

cmd "chown $(id -u):$(id -g) $DIST_FOLDER/syslog-stdout*"
